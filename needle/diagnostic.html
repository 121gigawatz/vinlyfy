<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vinylfy Diagnostics</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 { color: #d4a574; }
    .test {
      margin: 10px 0;
      padding: 10px;
      background: #2d2d2d;
      border-radius: 4px;
    }
    .pass { border-left: 4px solid #4caf50; }
    .fail { border-left: 4px solid #f44336; }
    .pending { border-left: 4px solid #ff9800; }
    pre {
      background: #0d0d0d;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    button {
      background: #d4a574;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>üîç Vinylfy Diagnostics</h1>
  <div id="tests"></div>
  <button onclick="runTests()">Run Tests Again</button>
  <button onclick="window.location.href='/'">Go to Vinylfy</button>

  <script type="module">
    const testsDiv = document.getElementById('tests');

    function addTest(name, status, message, data = null) {
      const div = document.createElement('div');
      div.className = `test ${status}`;
      div.innerHTML = `
        <strong>${status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚è≥'} ${name}</strong>
        <p>${message}</p>
        ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
      `;
      testsDiv.appendChild(div);
    }

    async function runTests() {
      testsDiv.innerHTML = '';

      // Test 1: Check API Health
      try {
        addTest('API Health Check', 'pending', 'Checking...');
        const response = await fetch('/api/health');
        const data = await response.json();

        if (data.status === 'healthy') {
          addTest('API Health Check', 'pass', `API is healthy. Version: ${data.version}`, data);
        } else {
          addTest('API Health Check', 'fail', 'API is not healthy', data);
        }
      } catch (error) {
        addTest('API Health Check', 'fail', `Error: ${error.message}`);
      }

      // Test 2: Check Service Worker Status
      try {
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          if (registrations.length === 0) {
            addTest('Service Worker', 'pass', 'No service workers registered (good for testing)');
          } else {
            addTest('Service Worker', 'fail', `${registrations.length} service worker(s) still registered`,
              registrations.map(r => ({ scope: r.scope, state: r.active?.state })));
          }
        } else {
          addTest('Service Worker', 'pass', 'Service workers not supported');
        }
      } catch (error) {
        addTest('Service Worker', 'fail', `Error: ${error.message}`);
      }

      // Test 3: Check Caches
      try {
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          if (cacheNames.length === 0) {
            addTest('Browser Cache', 'pass', 'No caches found (good for testing)');
          } else {
            addTest('Browser Cache', 'fail', `${cacheNames.length} cache(s) still present`, cacheNames);
          }
        }
      } catch (error) {
        addTest('Browser Cache', 'fail', `Error: ${error.message}`);
      }

      // Test 4: Load app.js
      try {
        addTest('Load app.js', 'pending', 'Loading module...');
        const response = await fetch('/js/app.js');
        const text = await response.text();
        const versionMatch = text.match(/const APP_VERSION = '([^']+)'/);

        if (versionMatch) {
          addTest('Load app.js', 'pass', `Successfully loaded. Version: ${versionMatch[1]}`);
        } else {
          addTest('Load app.js', 'fail', 'Loaded but version not found');
        }
      } catch (error) {
        addTest('Load app.js', 'fail', `Error: ${error.message}`);
      }

      // Test 5: Check localStorage
      const vinylfyVersion = localStorage.getItem('vinylfy_version');
      if (vinylfyVersion) {
        addTest('localStorage Version', 'fail', `Old version cached: ${vinylfyVersion} (should be cleared)`);
      } else {
        addTest('localStorage Version', 'pass', 'No cached version');
      }

      // Test 6: Try to import app.js as module
      try {
        addTest('Import app.js', 'pending', 'Attempting module import...');
        const module = await import('/js/app.js?t=' + Date.now());
        addTest('Import app.js', 'pass', 'Module imported successfully', { exports: Object.keys(module) });
      } catch (error) {
        addTest('Import app.js', 'fail', `Import failed: ${error.message}\n\nStack: ${error.stack}`);
      }
    }

    // Run tests on load
    window.runTests = runTests;
    runTests();
  </script>
</body>
</html>
